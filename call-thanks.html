<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>تم التحويل للاتصال - شركة الحبيب لتنظيف المنازل</title>
  <meta name="description" content="شكراً لتواصلك معنا في شركة الحبيب لتنظيف المنازل. جاري تحويلك إلى الاتصال المباشر بخدمة العملاء.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <link rel="canonical" href="https://elhbebclean.github.io/Elhabib_clean_home/call-thanks.html">

  <!-- مهم: نعرّف dataLayer مبكّر -->
  <script>
    window.dataLayer = window.dataLayer || [];
  </script>

  <!-- ---------- سكربت يلتقط الرقم ويعمل هاش ويدفعه للـ dataLayer ---------- -->
  <script>
    (function(){
      // مساعدة لالتقاط باراميتر من الرابط
      function getParam(name) {
        try { return (new URL(window.location.href)).searchParams.get(name); } catch(e) { return null; }
      }

      // التقط الرقم من ?phone= أو من sessionStorage
      var phone = getParam('phone') || null;
      try {
        if (!phone && sessionStorage.getItem && sessionStorage.getItem('userPhone')) {
          phone = sessionStorage.getItem('userPhone');
        }
      } catch(e){ phone = phone || null; }

      if (!phone) {
        // لا ندفع أي user_data فاضي — نترك dataLayer كما هو
        window.customerPhone = null;
        return;
      }

      // تنظيف الرقم: ارقام فقط
      phone = String(phone).replace(/\D+/g,'').trim();
      if (!phone) { window.customerPhone = null; return; }
      window.customerPhone = phone;

      // SHA-256 helper -> hex
      async function sha256Hex(s){
        const enc = new TextEncoder().encode(String(s));
        const buf = await crypto.subtle.digest('SHA-256', enc);
        return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
      }

      // احسب الهَش وادفعه فورًا للـ dataLayer (قبل تحميل GTM tags)
      (async function pushHash(){
        try {
          const phoneHash = await sha256Hex(phone);
          // دفع user_data بصيغة متعارف عليها
          window.dataLayer.push({
            'event': 'enhanced_conv_ready',
            'user_data': {
              'phone_number': phoneHash
            }
          });
          // خزّن الرقم خام للاستخدام لاحقاً (اختياري)
          try { sessionStorage.setItem('userPhone', phone); } catch(e){}
          console.log('Pushed enhanced_conv_ready with phone hash to dataLayer');
        } catch(err) {
          console.warn('Failed to push enhanced conv data', err);
        }
      })();
    })();
  </script>
  <!-- --------------------------------------------------------------------- -->

  <!-- Google Tag Manager (gtm.js) / Google Ads - يبقى بعد دفع dataLayer -->
  <script>
    (function(w,d,s,l,i){
      w[l]=w[l]||[];
      w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0],
          j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
      j.async=true;
      j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
      f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KLM4RMFM');
  </script>

  <!-- Google Ads gtag (يبقى بعد الـ dataLayer وGTM) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-16529004339"></script>
  <script>
    function gtag(){window.dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-16529004339');
  </script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 40px; background-color: #f9f9f9; }
    h1 { color: #28a745; font-size: 28px; }
    p { font-size: 18px; margin-bottom: 20px; }
    a.map-link { display: inline-block; margin-top: 25px; font-size: 18px; color: #007bff; text-decoration: underline; }
    a.call-now { display: inline-block; margin-top: 30px; font-size: 18px; color: white; background: #28a745; padding: 12px 25px; border-radius: 6px; text-decoration: none; }
  </style>
</head>
<body>
  <!-- GTM noscript -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KLM4RMFM" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <h1>✅ شكراً لتواصلك معنا!</h1>
  <p>سيتم تحويلك الآن لاتصال مباشر بخدمة العملاء خلال ثوانٍ قليلة.</p>

  <a id="fallbackCall" href="tel:01016961497" class="call-now">📞 اضغط للاتصال الآن</a>

  <h2 style="margin-top: 40px;">📍 موقعنا على Google Maps</h2>
  <a href="https://maps.app.goo.gl/wkatbwKjdm4J5vp48" target="_blank" class="map-link">اضغط هنا لفتح موقعنا على Google Maps مباشرة</a>

  <!-- (باقي الصفحة كما هي) -->

  <script>
    /***********************
     * إرسال conversion كما في الكود السابق
     * (هذا الجزء يرسل الحدث عبر gtag لكنه لن يُرسل user_data فارغ)
     ***********************/
    (async function sendConversionAndCall(){
      try {
        const phone = window.customerPhone || null;
        // احصل على gclid من الرابط أو الكوكيز
        function getGclid(){
          try {
            const p = (new URL(window.location.href)).searchParams.get('gclid');
            if (p){ document.cookie = "gclid=" + p + "; path=/; max-age=" + 60*60*24*90; return p; }
            const m = document.cookie.match(new RegExp('(^| )gclid=([^;]+)'));
            return m ? m[2] : null;
          } catch(e) { return null; }
        }
        const gclid = getGclid();

        const conversionLabel = 'OIQ7COaD0ewaELOu0sk9';
        const sendTo = 'AW-16529004339/' + conversionLabel;

        // قبل إرسال event عبر gtag، نتحقق إن DataLayer فيه user_data (لمنع الإرسال بدون بيانات)
        // ابحث في آخر عناصر dataLayer عن user_data
        function findLatestUserData(){
          try {
            const dl = window.dataLayer || [];
            for (let i = dl.length - 1; i >= 0; i--) {
              if (dl[i] && dl[i].user_data && dl[i].user_data.phone_number) return dl[i].user_data;
            }
          } catch(e){}
          return null;
        }

        const dlUser = findLatestUserData();
        const eventObj = { 'send_to': sendTo, 'value': 100.00, 'currency': 'EGP' };

        if (dlUser && dlUser.phone_number) {
          // إذا وجدنا user_data في dataLayer نرسله مع الحدث (آمن)
          eventObj.user_data = { 'phone_number': dlUser.phone_number };
          if (gclid) eventObj.user_data.gclid = gclid;
        } else if (phone) {
          // احتياط: لو لم يدفع الـ dataLayer (لسبب ما) لكن لدينا phone خام، نعمل هاش محلياً ثم نرسله
          try {
            const enc = new TextEncoder().encode(String(phone));
            const buf = await crypto.subtle.digest('SHA-256', enc);
            const h = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
            eventObj.user_data = { 'phone_number': h };
            if (gclid) eventObj.user_data.gclid = gclid;
          } catch(e){}
        } else {
          // لا نضيف user_data فاضية
        }

        // منع الإرسال المزدوج
        if (window.__conversion_sent) return;
        window.__conversion_sent = true;

        // fallback redirect
        let redirected = false;
        const doRedirect = function(){ if (!redirected) { redirected = true; window.location.href = "tel:01016961497"; } };
        const fbTimer = setTimeout(doRedirect, 6000);

        // ارسال الحدث
        gtag('event', 'conversion', Object.assign({}, eventObj, {
          'event_callback': function() { clearTimeout(fbTimer); doRedirect(); }
        }));

      } catch(err) {
        console.warn('conversion send failed', err);
        try { window.location.href = "tel:01016961497"; }catch(e){}
      }
    })();
  </script>
</body>
</html>
