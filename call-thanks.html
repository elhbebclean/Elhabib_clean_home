<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>تم التحويل للاتصال - شركة الحبيب لتنظيف المنازل</title>
  <meta name="description" content="شكراً لتواصلك معنا في شركة الحبيب لتنظيف المنازل. جاري تحويلك إلى الاتصال المباشر بخدمة العملاء.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <link rel="canonical" href="https://elhbebclean.github.io/Elhabib_clean_home/call-thanks.html">

  <!-- Google Tag Manager -->
  <script>
    (function(w,d,s,l,i){
      w[l]=w[l]||[];
      w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0],
          j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
      j.async=true;
      j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
      f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KLM4RMFM');
  </script>
  <!-- End Google Tag Manager -->

  <!-- Google Ads Conversion Tracking -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-16529004339"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-16529004339');
  </script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 40px; background-color: #f9f9f9; }
    h1 { color: #28a745; font-size: 28px; }
    p { font-size: 18px; margin-bottom: 20px; }
    a.map-link { display: inline-block; margin-top: 25px; font-size: 18px; color: #007bff; text-decoration: underline; }
    a.call-now { display: inline-block; margin-top: 30px; font-size: 18px; color: white; background: #28a745; padding: 12px 25px; border-radius: 6px; text-decoration: none; }
  </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KLM4RMFM"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <h1>✅ شكراً لتواصلك معنا!</h1>
  <p>سيتم تحويلك الآن لاتصال مباشر بخدمة العملاء خلال ثوانٍ قليلة.</p>

  <!-- زر احتياطي في حال لم يعمل التحويل التلقائي -->
  <a id="fallbackCall" href="tel:01016961497" class="call-now">📞 اضغط للاتصال الآن</a>

  <h2 style="margin-top: 40px;">📍 موقعنا على Google Maps</h2>
  <a href="https://maps.app.goo.gl/wkatbwKjdm4J5vp48" target="_blank" class="map-link">
    اضغط هنا لفتح موقعنا على Google Maps مباشرة
  </a>

  <!-- عنصر HTML مخفي يحوي رقم العميل (سيُملأ ديناميكيًا) -->
  <span id="customer-phone" style="display:none"></span>

  <script>
    /***********************
     * 1) التقاط رقم العميل ديناميكياً من:
     *    - query param ?phone=
     *    - sessionStorage 'userPhone' (إن وُجد)
     *    - (fallback لا نستخدمه كـ user_data)
     ***********************/
    (function(){
      function getParam(name) {
        try {
          return (new URL(window.location.href)).searchParams.get(name);
        } catch (e) {
          return null;
        }
      }

      var phone = null;

      // من رابط الصفحة ?phone=
      phone = getParam('phone') || phone;

      // من sessionStorage (لو خزّنته من صفحة سابقة)
      try {
        if (!phone && sessionStorage.getItem('userPhone')) {
          phone = sessionStorage.getItem('userPhone');
        }
      } catch(e){}

      // تنظيف الرقم (أرقام فقط) وكتابة DOM + متغير نافذة
      if (phone) {
        phone = String(phone).replace(/\D+/g, '');
        if (phone.length > 0) {
          document.getElementById('customer-phone').textContent = phone;
          window.customerPhone = phone;
          try { sessionStorage.setItem('userPhone', phone); } catch(e){}
        } else {
          document.getElementById('customer-phone').textContent = '';
          window.customerPhone = null;
        }
      } else {
        document.getElementById('customer-phone').textContent = '';
        window.customerPhone = null;
      }
    })();

    /***********************
     * 2) دالة SHA-256 (تعمل على سلسلة الأرقام فقط)
     ***********************/
    async function sha256Digits(message) {
      if (!message) return null;
      const digitsOnly = String(message).replace(/\D+/g, '').trim().toLowerCase();
      if (!digitsOnly) return null;
      const msgBuffer = new TextEncoder().encode(digitsOnly);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    /***********************
     * 3) التقاط gclid وتخزينه في كوكيز إن وجد
     ***********************/
    function getGclid() {
      try {
        const p = (new URL(window.location.href)).searchParams.get('gclid');
        if (p) {
          document.cookie = "gclid=" + p + "; path=/; max-age=" + 60*60*24*90;
          return p;
        } else {
          const match = document.cookie.match(new RegExp('(^| )gclid=([^;]+)'));
          return match ? match[2] : null;
        }
      } catch(e) {
        return null;
      }
    }

    /***********************
     * 4) إرسال conversion (مع user_data فقط لو موجود phoneHash)
     *    ثم إعادة التوجيه للاتصال (fallback بعد 6s)
     ***********************/
    (async function sendConversionAndCall(){
      try {
        const phone = window.customerPhone; // قد تكون null
        const gclid = getGclid();

        // لا نستخدم رقم الشركة كـ user_data — فقط كـ redirect fallback
        const phoneHash = phone ? await sha256Digits(phone) : null;

        // غيّر الـ conversionLabel إن كنت تستخدم قيمة مختلفة في حسابك
        const conversionLabel = 'OIQ7COaD0ewaELOu0sk9';
        const sendTo = 'AW-16529004339/' + conversionLabel;

        // بناء حدث التحويل بدون user_data افتراضياً
        const eventObj = {
          'send_to': sendTo,
          'value': 100.00,
          'currency': 'EGP'
        };

        // أضف user_data فقط إذا عندك phoneHash صالح (SHA-256 hex)
        if (phoneHash) {
          eventObj.user_data = { 'phone_number': phoneHash };
          if (gclid) eventObj.user_data.gclid = gclid;
        } else if (gclid) {
          // اختيارياً يمكن ترك gclid فقط، لكن الأفضل أن يترافق مع user_data
          // eventObj.user_data = { 'gclid': gclid };
        }

        // منع الإرسال المزدوج
        if (window.__conversion_sent) return;
        window.__conversion_sent = true;

        // redirect fallback after 6s
        let redirected = false;
        const doRedirect = function(){
          if (!redirected) {
            redirected = true;
            window.location.href = "tel:01016961497";
          }
        };
        const fbTimer = setTimeout(doRedirect, 6000);

        // أرسل الحدث عبر gtag
        gtag('event', 'conversion', Object.assign({}, eventObj, {
          'event_callback': function() {
            clearTimeout(fbTimer);
            doRedirect();
          }
        }));

      } catch (err) {
        console.warn('conversion send failed', err);
        // لو فشل شيء — نعيد التوجيه فوراً
        try { window.location.href = "tel:01016961497"; } catch(e){}
      }
    })();
  </script>
</body>
</html>
